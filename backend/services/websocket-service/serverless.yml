service: fridays-websocket-service

frameworkVersion: '3'

provider:
  name: aws
  runtime: nodejs20.x
  region: us-east-1
  stage: ${opt:stage, 'dev'}
  profile: ${opt:profile, 'fridays-dev'}
  
  environment:
    STAGE: ${self:provider.stage}
    CONNECTIONS_TABLE: WSConnections-${self:provider.stage}
    WEBSOCKET_ENDPOINT: 
      Fn::Join:
        - ''
        - - 'https://'
          - Ref: WebsocketsApi
          - '.execute-api.'
          - ${self:provider.region}
          - '.amazonaws.com/'
          - ${self:provider.stage}
  
  # AWS Academy: Usar LabRole existente
  iam:
    role: arn:aws:iam::139051438271:role/LabRole

functions:
  onConnect:
    handler: functions/connection/onConnect.handler
    events:
      - websocket:
          route: $connect

  onDisconnect:
    handler: functions/connection/onDisconnect.handler
    events:
      - websocket:
          route: $disconnect

  handleOrderStatusChange:
    handler: functions/events/handleOrderStatusChange.handler
    events:
      - eventBridge:
          pattern:
            source:
              - fridays.delivery
            detail-type:
              - OrderStatusChanged

# La tabla WSConnections-dev ya fue creada manualmente
# resources:
#   Resources:
#     ConnectionsTable:
#       Type: AWS::DynamoDB::Table
#       Properties:
#         TableName: ${self:provider.environment.CONNECTIONS_TABLE}
#         AttributeDefinitions:
#           - AttributeName: connectionId
#             AttributeType: S
#         KeySchema:
#           - AttributeName: connectionId
#             KeyType: HASH
#         BillingMode: PAY_PER_REQUEST
#         TimeToLiveSpecification:
#           AttributeName: ttl
#           Enabled: true

plugins:
  - serverless-offline

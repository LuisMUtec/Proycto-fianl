service: fridays-ecommerce-service

frameworkVersion: '3'

provider:
  name: aws
  runtime: nodejs20.x
  region: us-east-1
  stage: ${opt:stage, 'dev'}
  
  # ⚠️ AWS ACADEMY: Usar LabRole (sin credenciales)
  iam:
    role: arn:aws:iam::085179068256:role/LabRole
  
  environment:
    STAGE: ${self:provider.stage}
    REGION: us-east-1
    PRODUCTS_TABLE: Products-${self:provider.stage}
    ORDERS_TABLE: Orders-${self:provider.stage}
    USERS_TABLE: Users-${self:provider.stage}
    CARTS_TABLE: Carts-${self:provider.stage}
    CHEFS_TABLE: Chefs-${self:provider.stage}
    DRIVERS_TABLE: Drivers-${self:provider.stage}
    SEDES_TABLE: Sedes-${self:provider.stage}
    WS_CONNECTIONS_TABLE: WSConnections-${self:provider.stage}
    EVENT_BUS_NAME: fridays-event-bus-${self:provider.stage}
    S3_BUCKET_NAME: fridays-product-images-${self:provider.stage}
    ORDER_PROCESSING_STATE_MACHINE_ARN: arn:aws:states:us-east-1:085179068256:stateMachine:FridaysOrderWorkflow-${self:provider.stage}
    SQS_ORDER_QUEUE_URL: https://sqs.us-east-1.amazonaws.com/085179068256/fridays-order-queue-${self:provider.stage}.fifo

    SNS_NOTIFICATIONS_TOPIC_ARN: arn:aws:sns:us-east-1:085179068256:fridays-notifications-${self:provider.stage}

# Configurar empaquetado para incluir shared
package:
  patterns:
    - 'functions/**'
    - 'shared/**'
    - '!shared/**/*.test.js'
    - '!**/*.md'


functions:
  # ============================================================================
  # AUTHORIZER (Compartido)
  # ============================================================================
  authorizer:
    handler: shared/auth/authorizer.handler

  # ============================================================================
  # AUTH SERVICE
  # ============================================================================

  register:
    handler: functions/auth/register.handler
    events:
      - http:
          path: /auth/register
          method: POST
          cors: true

  login:
    handler: functions/auth/login.handler
    events:
      - http:
          path: /auth/login
          method: POST
          cors: true

  refreshToken:
    handler: functions/auth/refresh-token.handler
    events:
      - http:
          path: /auth/refresh-token
          method: POST
          cors: true
          authorizer:
            name: authorizer
            type: REQUEST

  logout:
    handler: functions/auth/logout.handler
    events:
      - http:
          path: /auth/logout
          method: POST
          cors: true
          authorizer:
            name: authorizer
            type: REQUEST

  # ============================================================================
  # MENU (PUBLIC)
  # ============================================================================
  getMenu:
    handler: functions/menu/getMenu.handler
    events:
      - http:
          path: /menu
          method: GET
          cors: true

  getCategory:
    handler: functions/menu/getCategory.handler
    events:
      - http:
          path: /menu/{category}
          method: GET
          cors: true

  getProduct:
    handler: functions/menu/getProduct.handler
    events:
      - http:
          path: /menu/product
          method: GET
          cors: true
      - http:
          path: /menu/items/{itemId}
          method: GET
          cors: true

  searchMenu:
    handler: functions/menu/search.handler
    events:
      - http:
          path: /menu/search
          method: GET
          cors: true

  listCategories:
    handler: functions/menu/listCategories.handler
    events:
      - http:
          path: /menu/categories
          method: GET
          cors: true

  # ============================================================================
  # ORDERS (CLIENTE)
  # ============================================================================
  createOrder:
    handler: functions/orders/createOrder.handler
    events:
      - http:
          path: /orders
          method: POST
          cors: true
          authorizer:
            name: authorizer
            type: REQUEST

  getOrder:
    handler: functions/orders/getOrder.handler
    events:
      - http:
          path: /orders/{orderId}
          method: GET
          cors: true
          authorizer:
            name: authorizer
            type: REQUEST

  listUserOrders:
    handler: functions/orders/listUserOrders.handler
    events:
      - http:
          path: /users/orders
          method: GET
          cors: true
          authorizer:
            name: authorizer
            type: REQUEST

  listOrders:
    handler: functions/orders/listOrders.handler
    events:
      - http:
          path: /orders
          method: GET
          cors: true
          authorizer:
            name: authorizer
            type: REQUEST

  cancelOrder:
    handler: functions/orders/cancelOrder.handler
    events:
      - http:
          path: /orders/{orderId}/cancel
          method: PUT
          cors: true
          authorizer:
            name: authorizer
            type: REQUEST

  # ============================================================================
  # CART (CLIENTE)
  # ============================================================================
  validateCart:
    handler: functions/cart/validate.handler
    events:
      - http:
          path: /cart/validate
          method: POST
          cors: true
          authorizer:
            name: authorizer
            type: REQUEST
  addToCart:
    handler: functions/cart/addToCart.handler
    events:
      - http:
          path: /cart
          method: POST
          cors: true
          authorizer:
            name: authorizer
            type: REQUEST
  getCart:
    handler: functions/cart/getCart.handler
    events:
      - http:
          path: /cart
          method: GET
          cors: true
          authorizer:
            name: authorizer
            type: REQUEST
  clearCart:
    handler: functions/cart/clearCart.handler
    events:
      - http:
          path: /cart
          method: DELETE
          cors: true
          authorizer:
            name: authorizer
            type: REQUEST
  updateCart:
    handler: functions/cart/updateCart.handler
    events:
      - http:
          path: /cart
          method: PUT
          cors: true
          authorizer:
            name: authorizer
            type: REQUEST
  removeFromCart:
    handler: functions/cart/removeFromCart.handler
    events:
      - http:
          path: /cart/item/{productId}
          method: DELETE
          cors: true
          authorizer:
            name: authorizer
            type: REQUEST

  # ============================================================================
  # PRODUCTS ADMIN (ADMIN_SEDE)
  # ============================================================================
  adminCreateProduct:
    handler: functions/products-admin/createProduct.handler
    events:
      - http:
          path: /menu/productos
          method: POST
          cors: true
          authorizer:
            name: authorizer
            type: REQUEST

  adminUpdateItem:
    handler: functions/products-admin/updateItem.handler
    events:
      - http:
          path: /menu/items/{itemId}
          method: PUT
          cors: true
          authorizer:
            name: authorizer
            type: REQUEST

  adminUpdateAvailability:
    handler: functions/products-admin/updateAvailability.handler
    events:
      - http:
          path: /menu/items/{itemId}/availability
          method: PUT
          cors: true
          authorizer:
            name: authorizer
            type: REQUEST

  adminDeleteItem:
    handler: functions/products-admin/deleteItem.handler
    events:
      - http:
          path: /menu/items/{itemId}
          method: DELETE
          cors: true
          authorizer:
            name: authorizer
            type: REQUEST

  # ============================================================================
  # NUEVAS FUNCIONES AGREGADAS - ECOMMERCE
  # ============================================================================
  adminListProducts:
    handler: functions/products-admin/listProducts.handler
    events:
      - http:
          path: /menu/productos
          method: GET
          cors: true
          authorizer:
            name: authorizer
            type: REQUEST

  adminGetProduct:
    handler: functions/products-admin/getProduct.handler
    events:
      - http:
          path: /menu/productos/{productId}
          method: GET
          cors: true
          authorizer:
            name: authorizer
            type: REQUEST


  deleteOrder:
    handler: functions/orders/deleteOrder.handler
    events:
      - http:
          path: /orders/{orderId}
          method: DELETE
          cors: true
          authorizer:
            name: authorizer
            type: REQUEST


resources:
  - ${file(resources/orders-table.yml)}

plugins:
  - serverless-offline

custom:
  serverless-offline:
    httpPort: 3001
    stage: local
    noAuth: true

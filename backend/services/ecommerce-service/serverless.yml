service: fridays-ecommerce-service

frameworkVersion: '3'

provider:
  name: aws
  runtime: nodejs20.x
  region: us-east-1
  stage: ${opt:stage, 'dev'}
  profile: ${opt:profile, 'fridays-dev'}
  
  environment:
    STAGE: ${self:provider.stage}
    PRODUCTS_TABLE: Products-${self:provider.stage}
    CARTS_TABLE: Carts-${self:provider.stage}
    ORDERS_TABLE: Orders-${self:provider.stage}
    USERS_TABLE: Users-${self:provider.stage}
    JWT_SECRET: fridays-secret-key-2025-proyectofinal
  
  # AWS Academy: Usar LabRole existente
  iam:
    role: arn:aws:iam::139051438271:role/LabRole

functions:
  authorizer:
    handler: ../../shared/auth/authorizer.handler

  # Auth
  register:
    handler: functions/auth/register.handler
    events:
      - http:
          path: /auth/register
          method: POST
          cors: true

  login:
    handler: functions/auth/login.handler
    events:
      - http:
          path: /auth/login
          method: POST
          cors: true

  # Menú y Catálogo
  listProducts:
    handler: functions/menu/listProducts.handler
    events:
      - http:
          path: /menu
          method: GET
          cors: true

  getProductsByCategory:
    handler: functions/menu/getProductsByCategory.handler
    events:
      - http:
          path: /menu/{category}
          method: GET
          cors: true

  # Carrito
  addToCart:
    handler: functions/cart/addToCart.handler
    events:
      - http:
          path: /cart/add
          method: POST
          cors: true
          authorizer:
            name: authorizer
            type: REQUEST

  getCart:
    handler: functions/cart/getCart.handler
    events:
      - http:
          path: /cart
          method: GET
          cors: true
          authorizer:
            name: authorizer
            type: REQUEST

  updateCart:
    handler: functions/cart/updateCart.handler
    events:
      - http:
          path: /cart/update
          method: PUT
          cors: true
          authorizer:
            name: authorizer
            type: REQUEST

  removeFromCart:
    handler: functions/cart/removeFromCart.handler
    events:
      - http:
          path: /cart/remove/{itemId}
          method: DELETE
          cors: true
          authorizer:
            name: authorizer
            type: REQUEST

  clearCart:
    handler: functions/cart/clearCart.handler
    events:
      - http:
          path: /cart/clear
          method: POST
          cors: true
          authorizer:
            name: authorizer
            type: REQUEST

  # Pedidos Cliente
  createOrder:
    handler: functions/orders/checkout.handler
    events:
      - http:
          path: /orders
          method: POST
          cors: true
          authorizer:
            name: authorizer
            type: REQUEST

  getOrder:
    handler: functions/orders/getOrder.handler
    events:
      - http:
          path: /orders/{orderId}
          method: GET
          cors: true
          authorizer:
            name: authorizer
            type: REQUEST

  getMyOrders:
    handler: functions/orders/getMyOrders.handler
    events:
      - http:
          path: /users/orders
          method: GET
          cors: true
          authorizer:
            name: authorizer
            type: REQUEST

plugins:
  - serverless-offline

custom:
  serverless-offline:
    httpPort: 3001
    stage: local
    noAuth: true

resources:
  Resources:
    UsersTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: Users-${self:provider.stage}
        AttributeDefinitions:
          - AttributeName: id
            AttributeType: S
          - AttributeName: email
            AttributeType: S
        KeySchema:
          - AttributeName: id
            KeyType: HASH
        BillingMode: PAY_PER_REQUEST
        GlobalSecondaryIndexes:
          - IndexName: email-index
            KeySchema:
              - AttributeName: email
                KeyType: HASH
            Projection:
              ProjectionType: ALL
    ProductsTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: Products-${self:provider.stage}
        AttributeDefinitions:
          - AttributeName: productId
            AttributeType: S
          - AttributeName: tenantId
            AttributeType: S
          - AttributeName: category
            AttributeType: S
        KeySchema:
          - AttributeName: productId
            KeyType: HASH
        BillingMode: PAY_PER_REQUEST
        GlobalSecondaryIndexes:
          - IndexName: tenantId-category-index
            KeySchema:
              - AttributeName: tenantId
                KeyType: HASH
              - AttributeName: category
                KeyType: RANGE
            Projection:
              ProjectionType: ALL
    CartsTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: Carts-${self:provider.stage}
        AttributeDefinitions:
          - AttributeName: userId
            AttributeType: S
        KeySchema:
          - AttributeName: userId
            KeyType: HASH
        BillingMode: PAY_PER_REQUEST
    OrdersTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: Orders-${self:provider.stage}
        AttributeDefinitions:
          - AttributeName: orderId
            AttributeType: S
          - AttributeName: userId
            AttributeType: S
          - AttributeName: createdAt
            AttributeType: S
        KeySchema:
          - AttributeName: orderId
            KeyType: HASH
        BillingMode: PAY_PER_REQUEST
        GlobalSecondaryIndexes:
          - IndexName: userId-createdAt-index
            KeySchema:
              - AttributeName: userId
                KeyType: HASH
              - AttributeName: createdAt
                KeyType: RANGE
            Projection:
              ProjectionType: ALL
